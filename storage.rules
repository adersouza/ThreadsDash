rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    // Allow authenticated users to upload media to their own folder
    match /users/{userId}/media/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow create/update with file size and type validation
      allow create, update: if request.auth != null && request.auth.uid == userId
        && request.resource.size < 50 * 1024 * 1024  // 50MB limit
        && request.resource.contentType.matches('image/.*|video/.*');  // Only images and videos
      // Allow delete without checking request.resource (which doesn't exist for deletes)
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Temporary files - restricted access with time-based expiration
    // These are used for image processing before upload to Threads API
    match /temp/{userId}/{fileName} {
      // Only allow read if:
      // 1. User is authenticated and owns the file, OR
      // 2. File was created within the last 1 hour (3600000ms)
      allow read: if (request.auth != null && request.auth.uid == userId) ||
                     (resource.timeCreated > request.time - duration.value(1, 'h'));

      // Only authenticated users can create temp files in their own folder
      allow create: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.size < 50 * 1024 * 1024 &&  // 50MB limit
                       request.resource.contentType.matches('image/.*|video/.*');

      // Only the owner or Cloud Functions can delete
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
