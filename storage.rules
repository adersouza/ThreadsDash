rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    // Allow authenticated users to upload media to their own folder
    match /users/{userId}/media/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow create/update with file size and type validation
      allow create, update: if request.auth != null && request.auth.uid == userId
        && request.resource.size < 50 * 1024 * 1024  // 50MB limit
        && request.resource.contentType.matches('image/.*|video/.*');  // Only images and videos
      // Allow delete without checking request.resource (which doesn't exist for deletes)
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Allow public read access for temporary spoofed images
    // (needed for Threads API to download images)
    match /temp/{userId}/{fileName} {
      allow read: if true;  // Public read access
      allow write: if false;  // Only Cloud Functions can write here
      allow delete: if false;  // Only Cloud Functions can delete
    }
  }
}
